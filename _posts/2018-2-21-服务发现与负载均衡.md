---
layout:     post
title:      服务发现与负载均衡
subtitle:   《Kubernetes指南》书摘
date:       2018-02-21
author:     cjx
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - K8S
---

## 引言

Kubernetes在设计之初就充分考虑了针对容器的服务发现与负载均衡机制，提供了Service资源，并通过kube-proxy配合cloud provider来适应不同的应用场景。随着kubernetes用户的激增，用户场景的不断丰富，又产生了一些新的负载均衡机制。目前，kubernetes中的负载均衡大致可以分为以下几种机制，每种机制都有其特定的应用场景：

1. Service：直接用Service提供cluster内部的负载均衡，并借助cloud provider提供的LB提供外部访问。

2. Ingress Controller：还是用Service提供cluster内部的负载均衡，但是通过自定义LB提供外部访问。

3. Service Load Balancer：把load balancer直接跑在容器中，实现Bare Metal的Service Load Balancer。

4. Custom Load Balancer：自定义负载均衡，并替代kube-proxy，一般在物理部署Kubernetes时使用，方便接入公司已有的外部服务。

## Service

![](/img/service-01.png)

Service是对一组提供相同功能的Pods的抽象，并为它们提供一个统一的入口。借助Service，应用可以方便的实现服务发现与负载均衡，并实现应用的零宕机升级。Service通过标签来选取服务后端，一般配合Replication Controller或者Deployment来保证后端容器的正常运行。这些匹配标签的Pod IP和端口列表组成endpoints，由kube-proxy负责将服务IP负载均衡到这些endpoints上。

Service有四种类型：

1. ClusterIP：默认类型，自动分配一个仅cluster内部可以访问的虚拟IP。

2. NodePort：在ClusterIP基础上为Service在每台机器上绑定一个端口，这样就可以通过<NodeIP>:NodePort来访问该服务。

3. Load Balancer： 在NodePort的基础上，借助cloud provider创建一个外部的负载均衡器，并将请求转发到<NodeIP>:NodePort。

4. ExternalName：将服务通过DNS CNAME记录方式转发到指定的域名（通过spec.externlName设定）。需要kube-dns版本1.7以上。

另外，也可以将已有的服务以Service的形式加入到Kubernetes集群中来，只需要在创建Service的时候不指定Label selector，而是在Service创建好后手动为其添加endpoint。

### Service定义

Service的定义也是通过yaml或json，比如下面定义了一个名为nginx的服务，将服务的80端口转发到default namespace中带有标签```run=nginx```的Pod的80端口。

```
apiVersion: v1
kind: Service
metadata:
  labels:
    run: nginx
  name: nginx
  namespace: default
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    run: nginx
  sessionAffinity: None
  type: ClusterIP
```

```
# service自动分配了Cluster IP 10.110.104.137
$ kubectl get service nginx
NAME      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
nginx     ClusterIP   10.110.104.137   <none>        80/TCP    9s

# 自动创建的endpoint
$ kubectl get endpoints nginx
NAME      ENDPOINTS        AGE
nginx     10.244.1.93:80   53s

# Service自动关联endpoint
$ kubectl describe service nginx
Name:              nginx
Namespace:         default
Labels:            run=nginx
Annotations:       <none>
Selector:          run=nginx
Type:              ClusterIP
IP:                10.110.104.137
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.1.93:80
Session Affinity:  None
Events:            <none>
```

#### 不指定Selectors的服务

在创建Service的时候，也可以不指定Selectors，用来将service转发到kubernetes集群外部的服务（而不是Pod）。目前支持两种方法：

（1）自定义endpoint，即创建同名的service和endpoint，在endpoint中设置外部服务的IP和端口。

```
kind: Service
apiVersion: v1
metadata:
  name: my-service
spec:
  ports:
    - protocol: TCP
      port: 80
      targetPort: 9376
---
kind: Endpoints
apiVersion: v1
metadata:
  name: my-service
subsets:
  - addresses:
      - ip: 1.2.3.4
    ports:
      - port: 9376
```

（2）通过DNS转发，在service定义中指定externalName。此时DNS服务会给```<service-name>.<namespace>.svc.cluster.local```创建一个CNAME记录，其值为```mv.database.example.com```。并且，该服务不会自动分配CLuster IP，需要通过service的DNS来访问（这种服务也称为Headless Service）。

```
kind: Service
apiVersion: v1
metadata:
  name: my-service
  namespace: default
spec:
  type: ExternalName
  externalName: my.database.example.com
```