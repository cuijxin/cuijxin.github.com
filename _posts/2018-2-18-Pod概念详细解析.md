---
layout:     post
title:      Pod概念详细解析
subtitle:   《Kubernetes指南》书摘
date:       2018-02-18
author:     cjx
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - K8S
---

## 引言

Pod是一组紧密关联的容器集合，它们共享IPC、Network和UTC namespace，是Kubernetes调度的基本单位。Pod的设计理念是支持多个容器在一个Pod中共享网络和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。
![](/img/pod-01.png)

#### Pod的特征

1. 包含多个共享的IPC、Network和UTC namespace的容器，可直接通过localhost通信。

2. Pod内所有容器都可以访问共享的Volume，可以访问共享数据。

3. Pod一旦调度后就跟Node绑定，即使Node挂掉也不会重新调度，推荐使用Deployments、Daemonsets等控制器来容错。

4. 优雅终止：Pod删除的时候先给其内的进程发送SIGTERM，等待一段时间（grace period）后才强制停止依然还在运行的进程。

5. 特权容器（通过SecurityContext配置）具有改变系统配置的权限（在网络插件中大量应用）

### Pod定义

通过yaml或json描述Pod和其内Container的运行环境以及期望状态，比如一个最简单的nginx pod可以定义为：
```
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80
```

#### 使用Volume
Volume可以为容器提供持久化存储，比如
```
apiVersion: v1
kind: Pod
metadata:
  name: redis
spec:
  containers:
  - name: redis
    image: redis
    volumeMounts:
    - name: redis-storage
      mountPath: /data/redis
  volumes:
  - name: redis-storage
    emptyDir: {}
```
这里为Pod挂载了一个emptyDir类型的Volume，并且挂载到容器的/data/redis目录。emptyDir类型的Volume的特点是，在Pod被分配到Node上的时候，会创建emptyDir，只要Pod运行在Node上，emptyDir都会存在（容器挂掉不会导致emptyDir丢失数据），但是如果Pod从Node上被删除（Pod被删除，或者Pod发生迁移），emptyDir也会被删除，并且永久丢失。